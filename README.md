![Tests](https://github.com/WildMeOrg/houston/workflows/Testing/badge.svg?branch=develop)
[![Codecov](https://codecov.io/gh/WildMeOrg/houston/branch/develop/graph/badge.svg?token=M8MR14ED6V)](https://codecov.io/gh/WildMeOrg/houston)
[![Docker Nightly](https://img.shields.io/docker/image-size/wildme/houston/nightly)](https://hub.docker.com/r/wildme/houston)

# Wild Me - Houston Backend Server

Houston is a REST API component within the CODEX application suite. It is used to glue the frontend to [Ecological Data Module (EDM)](https://github.com/WildMeOrg/wildbook/tree/next-gen) and [Wildbook-IA](https://github.com/WildMeOrg/wildbook-ia).

For a high-level explanation of the application in relation to other CODEX applications read the documentation at [CODEX - Houston](https://docs.wildme.org/docs/developers/houston).


## About this implementation

This project showcases my vision on how the RESTful API server should be
implemented.

The goals that were achieved in this example:

* RESTful API server should be self-documented using OpenAPI (fka Swagger) specifications, so interactive documentation UI is in place
* Authentication is handled with OAuth2 and using Resource Owner Password Credentials Grant (Password Flow) for first-party clients makes it usable not only for third-party "external" apps
* Permissions are handled (and automaticaly documented)
* PATCH method can be handled accordingly to [RFC 6902](http://tools.ietf.org/html/rfc6902)
* Extensive testing with good code coverage.

The package Flask-RESTX has been patched (see `flask_restx_patched` folder), so it can handle Marshmallow schemas and Webargs arguments.

## Code Style and Development Guidelines

See [Contributing to Houston](CONTRIBUTING.md)

## Project's Code Structure

See [Project Structure](docs/project_file_structure.md)

## Background and Periodic Tasks using Celery

See [Background and Periodic Tasks](docs/background_tasks.md)

## Installation

### Using docker-compose (recommended)

#### Setup

```bash
git clone --recurse-submodules https://github.com/WildMeOrg/houston.git
cd houston/deploy/codex
docker-compose up
```

Surf to http://localhost:84/


### Installing from source

#### Development Setup Note

Installation of Houston and the other components of Codex from source is intended to facilitate development leveraging the docker-compose environment.

See **Development Environment** section in [Contributing to Houston](CONTRIBUTING.md)
for details. Full deployment of Codex outside docker-compose orchestration is not supported, and any 
changes should not be considered finished until they have been tested in the docker-compose environment.

#### Clone the Project

```bash
git clone --recurse-submodules https://github.com/WildMeOrg/houston.git
cd houston/
```

#### Setup Environment

It is recommended to use virtualenv or Anaconda/Miniconda to manage Python
dependencies. Please, learn details yourself.
For quickstart purposes the following will set up a virtualenv for you:

```bash
./scripts/venv.sh
source virtualenv/houston3.7/bin/activate

# To add bash-completion
export SCRIPT="$(pwd)/.invoke-completion.sh"
invoke --print-completion-script bash > $SCRIPT
echo "source $SCRIPT" >> virtualenv/houston3.7/bin/activate
```

Set up and install the package:

```bash
invoke dependencies.install
```

#### Run Server

NOTE: All dependencies and database migrations will be automatically handled,
so go ahead and turn the server ON! (Read more details on this in Tips section)

```bash
$ invoke app.run
```

#### Deploy Server

In general, you deploy this app as any other Flask/WSGI application. There are
a few basic deployment strategies documented in the [`./deploy/`](./deploy/)
folder.


## Usage

Open online interactive API documentation:
[http://127.0.0.1:5000/api/v1/](http://127.0.0.1:5000/api/v1/)

Autogenerated swagger config is always available from
[http://127.0.0.1:5000/api/v1/swagger.json](http://127.0.0.1:5000/api/v1/swagger.json)

NOTE: Use On/Off switch in documentation to sign in.

### Usage Tips

Once you have invoke, you can learn all available commands related to this
project from:

```bash
$ invoke --list
```

Learn more about each command with the following syntax:

```bash
$ invoke --help <task>
```

For example:

```bash
$ invoke --help app.run
Usage: inv[oke] [--core-opts] app.run [--options] [other tasks here ...]

Docstring:
  Run DDOTS RESTful API Server.

Options:
  -d, --[no-]development
  -h STRING, --host=STRING
  -i, --[no-]install-dependencies
  -p, --port
  -u, --[no-]upgrade-db
```

Use the following command to enter ipython shell (`ipython` must be installed):

```bash
$ invoke app.env.enter
```

`app.run` and `app.env.enter` tasks automatically prepare all dependencies
(using `pip install`) and migrate database schema to the latest version.

Database schema migration is handled via `app.db.*` tasks group. The most
common migration commands are `app.db.upgrade` (it is automatically run on
`app.run`), and `app.db.migrate` (creates a new migration).

You can use [`better_exceptions`](https://github.com/Qix-/better-exceptions)
package to enable detailed tracebacks. Just add `better_exceptions` to the
`app/requirements.txt` and `import better_exceptions` in the `app/__init__.py`.

## Dependencies

### Project Dependencies

This project requires either [**Python**](https://www.python.org/) >= 3.7 or Docker.

The [_tus_](https://tus.io) portions of this application require [**Redis**](https://redis.io/) to facilitate resumable file uploads.

[**GitLab**](https://about.gitlab.com/install/) (community edition) is required for asset and submission storage and management.

[**Postgres**](https://www.postgresql.org/) is an optional dependency that can be used for a highly reliable scaled database solution.


## Documentation

### Build the documentation

To build and view the documentation use the following commands:

```
cd docs
pip install -r requirements.txt
make html
open _build/html/index.html
```


## License

This software is subject to the provisions of Apache License Version 2.0 (APL). See `LICENSE` for details. Copyright (c) 2020 Wild Me
